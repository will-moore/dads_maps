<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dad's Maps</title>
    <link
      rel="stylesheet"
      href="https://labs.os.uk/public/os-api-branding/v0.2.0/os-api-branding.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/css/ol.css"
    />
    <style>
      body {
        margin: 0;
        padding: 0;
      }

      #map {
        position: absolute;
        top: 0;
        bottom: 0;
        width: 100%;
      }

      .controls {
        position: absolute;
        top: 10px;
        background: white;
        border: solid 1px #ffbeff;
        border-radius: 10px;
      }

      button {
        top: 10px;
        width: 40px;
        height: 40px;
      }
      #centreMap {
        right: 10px;
      }
      #findGridRef {
        border: none;
        background: transparent;
        padding: 0;
        height: 33px;
        width: 33px;
      }
      #gridrefForm {
        top: 10px;
        right: 60px;
        padding: 3px 2px;
        display: flex;
        gap: 10px;
        align-items: center;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      #gridrefForm.expanded {
        left: 45px;
        padding: 10px;
      }

      #gridrefForm label {
        display: block;
        flex: 1 1 auto;
        white-space: nowrap;
        font-size: 20px;
        color: grey;
      }
      input {
        width: 100%;
        font-size: 24px;
        display: none;
      }
      .expanded input {
        display: inline;
      }
      input[name="letters"] {
        flex: 1 1 30%;
      }
      input[name="numbers"] {
        flex: 1 1 70%;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>

    <button id="centreMap" class="controls" title="Click to centre map on your position">
      <img src="images/crosshairs.png" style="width: 25px; height: 25px" />
    </button>

    <div id="gridrefForm" class="controls">
      <!-- <label>Grid Ref</label> -->
      <input id="gridRefLetters" name="letters" type="text" placeholder="NO"/>
      <input id="gridRefNumbers" name="numbers" type="number" placeholder="573752"/>
      <button id="findGridRef" title="Enter a grid reference to go to">
        <img src="images/search.svg" style="width: 25px; height: 25px" />
      </button>
    </div>

    <script src="https://labs.os.uk/public/os-api-branding/v0.2.0/os-api-branding.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.5.0/build/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.7.0/proj4.js"></script>
    <script src="./js/coords.js"></script>
    <script type="module">
      var apiKey = "YNN0DjzxNl9qWGu35kv7BkqRCqSmtsVz";

      var serviceUrl = "https://api.os.uk/maps/raster/v1/zxy";

      // https://www.movable-type.co.uk/scripts/latlong-os-gridref.html
      import OsGridRef, { LatLon } from "https://cdn.jsdelivr.net/npm/geodesy@2/osgridref.js";

      // Setup the EPSG:27700 (British National Grid) projection.
      proj4.defs(
        "EPSG:27700",
        "+proj=tmerc +lat_0=49 +lon_0=-2 +k=0.9996012717 +x_0=400000 +y_0=-100000 +ellps=airy +towgs84=446.448,-125.157,542.06,0.15,0.247,0.842,-20.489 +units=m +no_defs"
      );
      ol.proj.proj4.register(proj4);

      var tilegrid = new ol.tilegrid.TileGrid({
        resolutions: [
          896.0, 448.0, 224.0, 112.0, 56.0, 28.0, 14.0, 7.0, 3.5, 1.75,
        ],
        origin: [-238375.0, 1376256.0],
      });

      // Initialize the map object.
      var map = new ol.Map({
        layers: [
          new ol.layer.Tile({
            source: new ol.source.XYZ({
              url: serviceUrl + "/Leisure_27700/{z}/{x}/{y}.png?key=" + apiKey,
              projection: "EPSG:27700",
              tileGrid: tilegrid,
            }),
          }),
        ],
        target: "map",
        view: new ol.View({
          projection: "EPSG:27700",
          extent: [-238375.0, 0.0, 900000.0, 1376256.0],
          resolutions: tilegrid.getResolutions(),
          minZoom: 0,
          maxZoom: 9,
          center: [437297, 503695],
          zoom: 0,
        }),
      });

      // Add Vector layer for the sight-line
      const vectorLayer = new ol.layer.Vector({
        source: new ol.source.Vector(),
        style: new ol.style.Style({
          stroke: new ol.style.Stroke({
            color: "#f0f",
            width: 2,
          }),
          fill: new ol.style.Fill({
            color: "rgba(255, 0, 255, 0)",
          }),
        }),
      });
      map.addLayer(vectorLayer);

      var drawRect = function (points, id) {
        let x1 = parseInt(points[0]);
        let y1 = parseInt(points[1]);
        let x2 = parseInt(points[2]);
        let y2 = parseInt(points[3]);

        var polygonFeature = new ol.Feature({
          id: id,
          geometry: new ol.geom.Polygon([
            [
              [x1, y1],
              [x1, y2],
              [x2, y2],
              [x2, y1],
            ],
          ]),
        });
        vectorLayer.getSource().addFeature(polygonFeature);
        return polygonFeature;
      };

      DATA.forEach((element) => {
        drawRect(element.coords, element.id);
      });

      function dropPin(gridref) {
        const iconFeature = new ol.Feature({
          geometry: new ol.geom.Point([gridref.easting, gridref.northing]),
        });

        const iconStyle = new ol.style.Style({
          image: new ol.style.Icon({
            anchor: [0.5, 1],
            anchorXUnits: "fraction",
            anchorYUnits: "fraction",
            src: "images/drop-small.png",
          }),
        });

        iconFeature.setStyle(iconStyle);
        vectorLayer.getSource().addFeature(iconFeature);
      }

      // Handle location from browser...
      function locationCallback(position) {
        const latitude = position.coords.latitude;
        const longitude = position.coords.longitude;
        const wgs84 = new LatLon(latitude, longitude);
        const gridref = wgs84.toOsGrid();
        map.getView().setResolution(3);
        map.getView().setCenter([gridref.easting, gridref.northing]);

        // TODO: maybe don't ADD a feature each time!
        dropPin(gridref);
      }

      if (!navigator.geolocation) {
        console.log("Geolocation is not supported by your browser");
        document.getElementById("centreMap").style.visibility = "hidden";
      }

      // Event Listeners for Search Form...
      const grLetters = document.getElementById("gridRefLetters");
      const grNumbers = document.getElementById("gridRefNumbers");
      document.getElementById("findGridRef").addEventListener("click", () => {
        // button toggles visibility of form
        let gridrefForm = document.getElementById("gridrefForm");
        gridrefForm.classList.toggle('expanded');
      });
      grLetters.addEventListener("focus", (event) => {
        grLetters.select();
      });
      grLetters.addEventListener("input", (event) => {
        let value = event.target.value;
        // if 2 letters entered, upper-case them and focus on Numbers
        if (value.length == 2) {
          grLetters.value = value.toUpperCase();
          grNumbers.value = "";
          grNumbers.focus();
        }
      });
      grNumbers.addEventListener("input", (event) => {
        let value = event.target.value;
        // if 6 letters entered, go ahead and use...
        if (value.length == 6) {
          let gref = grLetters.value + " " + value;
          const gridref = OsGridRef.parse(gref);
          map.getView().setCenter([gridref.easting, gridref.northing]);
          dropPin(gridref);
        }
      });

      // Click to centre map on current location...
      let btn = document.getElementById("centreMap");
      btn.addEventListener("click", function () {
        console.log("Locatingâ€¦");
        navigator.geolocation.getCurrentPosition(locationCallback, function () {
          console.log("Error getting location");
        });
      });

      // listen for map panning events - update URL with gridref and zoom...
      map.on("moveend", function (e) {
        let center = map.getView().getCenter();

        // update grid-ref in form inputs
        let gr = new OsGridRef(center[0], center[1]);
        let grString = gr.toString(6);  // e.g. 'NO 306 735'
        grLetters.value = grString.slice(0, 2);
        grNumbers.value = grString.slice(3, 10).replace(" ", "");

        // update URL - replaceState instead of add to history
        let gridref = center
          // round to 100 and to integer String
          .map((n) => (Math.round(n / 100) * 100).toFixed(0))
          .join(",");
        let resolution = map.getView().getResolution().toFixed(0);
        history.replaceState(
          null,
          "",
          `?gridref=${gridref}&zoom=${resolution}`
        );
      });

      // When page loads, if we have ?gridref=... then set center
      const searchParams = new URLSearchParams(window.location.search);
      if (searchParams.has("gridref")) {
        const gridref = searchParams
          .get("gridref")
          .split(",")
          .map((x) => parseInt(x));
        map.getView().setCenter(gridref);
      }
      if (searchParams.has("zoom")) {
        const resolution = searchParams.get("zoom");
        map.getView().setResolution(parseInt(resolution));
      }
    </script>
  </body>
</html>
